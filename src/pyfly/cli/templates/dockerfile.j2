# --- Build stage ---
FROM python:3.12-slim AS builder

WORKDIR /build

COPY pyproject.toml .
COPY src/ src/

RUN pip install --no-cache-dir build \
    && python -m build --wheel --outdir /build/dist

# --- Runtime stage ---
FROM python:3.12-slim

WORKDIR /app

COPY --from=builder /build/dist/*.whl /tmp/
RUN pip install --no-cache-dir /tmp/*.whl \
    && rm /tmp/*.whl

COPY pyfly.yaml .

{% if archetype == "cli" %}
CMD ["python", "-m", "{{ package_name }}.main"]
{% elif has_web or archetype in ("web-api", "web", "hexagonal", "core") %}
EXPOSE 8080

CMD ["python", "-m", "uvicorn", "{{ package_name }}.main:app", "--host", "0.0.0.0", "--port", "8080"]
{% endif %}
