"""ASGI entry point â€” bootstraps PyFly and creates the web server."""

from pathlib import Path
from contextlib import asynccontextmanager

from starlette.staticfiles import StaticFiles

from pyfly.core import PyFlyApplication
from pyfly.web.adapters.starlette import create_app

from {{ package_name }}.app import Application

# Bootstrap: load config, scan packages, build DI context
_pyfly = PyFlyApplication(Application)
_static_dir = Path(__file__).parent / "static"


@asynccontextmanager
async def _lifespan(app):
    """Manage application startup and shutdown lifecycle."""
    _pyfly._route_metadata = getattr(app.state, "pyfly_route_metadata", [])
    _pyfly._docs_enabled = getattr(app.state, "pyfly_docs_enabled", False)
    _pyfly._host = str(_pyfly.config.get("pyfly.web.host", "0.0.0.0"))
    _pyfly._port = int(_pyfly.config.get("pyfly.web.port", 8080))
    await _pyfly.startup()
    yield
    await _pyfly.shutdown()


app = create_app(
    title="{{ name }}",
    version="0.1.0",
    context=_pyfly.context,
    lifespan=_lifespan,
)
app.mount("/static", StaticFiles(directory=str(_static_dir)), name="static")
