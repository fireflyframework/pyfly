"""Application services â€” use-case implementations."""

from __future__ import annotations

from pyfly.container import service

from {{ package_name }}.domain.models import Todo
{% if has_data %}
from {{ package_name }}.domain.models import TodoEntity
from {{ package_name }}.infrastructure.adapters.persistence import TodoRepository
{% elif has_mongodb %}
from {{ package_name }}.domain.models import TodoDocument
from {{ package_name }}.infrastructure.adapters.persistence import TodoDocumentRepository
{% else %}
from {{ package_name }}.infrastructure.adapters.persistence import InMemoryTodoRepository
{% endif %}


@service
class TodoService:
    """Implements the inbound ports for todo management."""
{% if has_data %}

    def __init__(self, repository: TodoRepository) -> None:
        self._repository = repository

    async def create(self, title: str, description: str) -> Todo:
        entity = TodoEntity(title=title, description=description)
        saved = await self._repository.save(entity)
        return Todo(id=str(saved.id), title=saved.title, description=saved.description, completed=saved.completed)

    async def get(self, todo_id: int) -> Todo:
        entity = await self._repository.find_by_id(todo_id)
        return Todo(id=str(entity.id), title=entity.title, description=entity.description, completed=entity.completed)

    async def list_all(self) -> list[Todo]:
        entities = await self._repository.find_all()
        return [Todo(id=str(e.id), title=e.title, description=e.description, completed=e.completed) for e in entities]

    async def toggle_complete(self, todo_id: int) -> Todo:
        entity = await self._repository.find_by_id(todo_id)
        entity.completed = not entity.completed
        saved = await self._repository.save(entity)
        return Todo(id=str(saved.id), title=saved.title, description=saved.description, completed=saved.completed)

    async def delete(self, todo_id: int) -> None:
        await self._repository.delete(todo_id)
{% elif has_mongodb %}

    def __init__(self, repository: TodoDocumentRepository) -> None:
        self._repository = repository

    async def create(self, title: str, description: str) -> Todo:
        doc = TodoDocument(title=title, description=description)
        saved = await self._repository.save(doc)
        return Todo(id=str(saved.id), title=saved.title, description=saved.description, completed=saved.completed)

    async def get(self, todo_id: str) -> Todo:
        doc = await self._repository.find_by_id(todo_id)
        return Todo(id=str(doc.id), title=doc.title, description=doc.description, completed=doc.completed)

    async def list_all(self) -> list[Todo]:
        docs = await self._repository.find_all()
        return [Todo(id=str(d.id), title=d.title, description=d.description, completed=d.completed) for d in docs]

    async def toggle_complete(self, todo_id: str) -> Todo:
        doc = await self._repository.find_by_id(todo_id)
        doc.completed = not doc.completed
        saved = await self._repository.save(doc)
        return Todo(id=str(saved.id), title=saved.title, description=saved.description, completed=saved.completed)

    async def delete(self, todo_id: str) -> None:
        await self._repository.delete(todo_id)
{% else %}

    def __init__(self, repository: InMemoryTodoRepository) -> None:
        self._repository = repository

    def create(self, title: str, description: str) -> Todo:
        todo = Todo(title=title, description=description)
        self._repository.save(todo)
        return todo

    def get(self, todo_id: str) -> Todo:
        return self._repository.find_by_id(todo_id)

    def list_all(self) -> list[Todo]:
        return self._repository.find_all()

    def toggle_complete(self, todo_id: str) -> Todo:
        todo = self._repository.find_by_id(todo_id)
        todo.completed = not todo.completed
        self._repository.save(todo)
        return todo

    def delete(self, todo_id: str) -> None:
        self._repository.delete(todo_id)
{% endif %}
